services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_REGISTRY_HTTP_URL=${VITE_REGISTRY_HTTP_URL:-http://localhost:8780}
    depends_on:
      - packet-agent
      - agent-registry

  agent-registry:
    build:
      context: .
      dockerfile: agent-registry/Dockerfile
    ports:
      - "8780:8780"

  packet-agent:
    build:
      context: ./packet-agent
      dockerfile: Dockerfile
    command:
      [
        "python",
        "agent.py",
        "run",
        "--upstream-url",
        "${FLEX_UPSTREAM_URL:-ws://agent-registry:8780/ws/agent}",
        "--agent-id",
        "${FLEX_AGENT_ID:-agent-docker}",
        "--agent-name",
        "${FLEX_AGENT_NAME:-Docker Packet Agent}",
        "--bpf",
        "${FLEX_AGENT_BPF:-tcp or udp}",
        "--protocol-port-map",
        "${FLEX_PROTOCOL_PORT_MAP:-}",
        "--endpoint-protocol-map",
        "${FLEX_ENDPOINT_PROTOCOL_MAP:-}",
      ]
    depends_on:
      - agent-registry
    cap_add:
      - NET_ADMIN
      - NET_RAW
    security_opt:
      - apparmor:unconfined
